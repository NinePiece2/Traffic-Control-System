@using Syncfusion.EJ2.Navigations
@using Syncfusion.EJ2
@using Syncfusion.EJ2.Grids
@{
    ViewData["Title"] = "Home Page";
}

<style>
    ::-webkit-scrollbar {
        width: 0px !important;
    }
   
    ::-webkit-scrollbar-thumb {
        background: #808080 !important;
    }

    .container {
        padding-top: 25px;
        max-width: 95%;
    }

    h2 {
        padding-left: 45px
    }

    .spacer {
        margin-left: 5px; 
    }

    .btn-primary{
        color: #050505 !important;
        background-color: orange;
        border-color: orange;
    }

    .btn-primary:focus {
        background-color: orange;
        border-color: orange !important;
    }

    .btn-primary:focus:active {
        background-color: orange;
        border-color: orange !important;
        box-shadow: 0 0 2px 1px orange !important;
    }

    .custom-access{
        color: #050505 !important;
        background-color: #dcda63;
        border-color: #dcda63;
    }

    .custom-access:focus {
        background-color: #dcda63;
        border-color: #dcda63 !important;
    }

    .custom-access:focus:active {
        background-color: #dcda63;
        border-color: #dcda63 !important;
        box-shadow: 0 0 2px 1px #dcda63 !important;
    }

    .e-dropdownbase .e-list-item {
        color: white;
        background-color: #1e1e22;
    }

    .e-dropdownbase .e-list-item:hover {
        color: white;
        background-color: #42A5F5;
    }

    .badge-danger{
        color: white;
        background-color: #dc3545;
    }
    
    .e-dropdownbase .e-list-item.e-active {
        color: white;
        background-color: #42A5F5 !important;
    }
</style>

<h2 style="display: inline-block;">Traffic Signals</h2>
<button type="button" class="btn btn-primary" style="margin-left: 797px;" data-toggle="modal" data-target="#exampleModalCenter">Add</button>

<div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" style="color: black;">Add New Traffic Signal</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            
            <div class="modal-body" style="color: black;" id="page1">
                <form id="trafficSignalForm">
                    <div class="form-group">
                        <label for="signalAddress">Traffic Signal Address:</label>
                        <input type="text" class="form-control" id="signalAddress" placeholder="Enter traffic signal address" required>
                    </div>
                    <div class="form-group">
                        <label for="signalDirection">Direction:</label>
                        <input type="text" class="form-control" id="signalDirection" placeholder="Enter direction" required>
                    </div>
                    <button type="button" class="btn btn-primary" onclick="saveAndNext()">Save, Next Page</button>
                </form>
            </div>

            <div class="modal-body" style="color: black; display: none;" id="page2">
                <div class="form-group">
                    <label for="deviceStreamId">Device Stream ID:</label>
                    <input type="text" class="form-control" id="deviceStreamId" readonly>
                </div>
                <div class="form-group">
                    <label for="apiKey">API Key:</label>
                    <input type="text" class="form-control" id="apiKey" readonly>
                </div>
                <button type="button" class="btn btn-secondary" onclick="goToPreviousPage()">Go Back</button>
                <button type="button" class="btn btn-primary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
    function saveAndNext() {
        var signalAddress = document.getElementById('signalAddress').value;
        var signalDirection = document.getElementById('signalDirection').value;
        
        if (!signalAddress || !signalDirection) {
            alert('Please fill in all fields.');
            return;
        }
        
        fetch('/Home/SaveTrafficSignal', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ address: signalAddress, direction: signalDirection })
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById('deviceStreamId').value = data.deviceStreamId;
            document.getElementById('apiKey').value = data.apiKey;
            document.getElementById('page1').style.display = 'none';
            document.getElementById('page2').style.display = 'block';
        })
        .catch(error => console.error('Error:', error));
    }

    function goToPreviousPage() {
        document.getElementById('page2').style.display = 'none';
        document.getElementById('page1').style.display = 'block';
    }
</script>

<div class="container">
            <div class="e-content"> 
                <div>
                    @(Html.EJS().Grid("adminSignalGrid")
                        .Height("400px")
                        .DataSource(dataManger => {
                            dataManger.Url("/Home/TrafficSignalsList").Key("id").CrossDomain(false);
                        })
                        .Columns(col => {
                            col.Field("id").HeaderText("ID").Width("120").Add();
                            col.Field("Address").HeaderText("Address").Width("150").Add();
                            col.Field("NumofViolations").HeaderText("Number of Violations").Width("150").Add();
                            
                            //button to incident report of specific violation
                            col.HeaderText("Actions").Template("<button class='k-button custom-access' onclick='onAccess(this)'>Access</button> ").Width("100").Add();
                            
                        })
                        .AllowPaging()
                        .Render()
                    )
                </div>
            </div>    
</div>

<script>
    function onAccess(button) {
        // Get the grid instance
        var gridObj = document.getElementById('adminSignalGrid').ej2_instances[0];

        // Find the closest row to the clicked button
        var row = button.closest('tr');

        // Retrieve the UID of the row
        var uid = row.getAttribute('data-uid');

        if (uid) {
            // Use the UID to get the row data
            var rowData = gridObj.getRowObjectFromUID(uid).data;

            // Extract the ID field from the row data
            var id = rowData.id; // Ensure 'id' is the correct field name in your grid data

            // Redirect to the IncidentReport page with the ID as a query parameter
            window.location.href = `/Home/IncidentReport?ID=${id}`;
        } else {
            console.error("UID not found in the row.");
        }
    }
</script>

